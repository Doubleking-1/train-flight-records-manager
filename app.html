<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <title>ç«è½¦ç¥¨è®°å½•ä¸åœ°å›¾ç¤ºä¾‹ï¼ˆå«æš—è‰²æ¨¡å¼ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- å¼•å…¥ API é…ç½®æ–‡ä»¶ -->
  <!-- Gemini Q&A Modal -->
  <div id="geminiQAModalOverlay"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
    <div
      style="background:var(--modal-bg); width:90%; max-width:600px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:80vh;">
      <div
        style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--text-color);">âœ¨ è¯¢é—® AI</h3>
        <button id="geminiQACloseBtn"
          style="background:none; border:none; font-size:20px; cursor:pointer; color:var(--text-color);">&times;</button>
      </div>
      <div style="padding:15px; flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
        <div id="geminiQAChatHistory"
          style="flex:1; min-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:4px; padding:10px; background:var(--bg-color); margin-bottom:10px;">
          <div style="color:var(--text-color); opacity:0.7; text-align:center; margin-top:20px;">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒAI
            å°†æ ¹æ®å½“å‰è¡¨æ ¼æ•°æ®è¿›è¡Œå›ç­”ã€‚</div>
        </div>
        <div style="display:flex; gap:10px;">
          <input type="text" id="geminiQAInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä»Šå¹´å»äº†å“ªäº›åŸå¸‚ï¼ŸèŠ±è´¹æœ€å¤šçš„æ˜¯å“ªæ¬¡ï¼Ÿ"
            style="flex:1; padding:8px; border:1px solid var(--input-border); border-radius:4px; background:var(--input-bg); color:var(--text-color);">
          <button id="geminiQASendBtn"
            style="padding:8px 15px; background:var(--primary-color); color:#fff; border:none; border-radius:4px; cursor:pointer;">å‘é€</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <!-- Leaflet CSS & JS (for OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- åŠ¨æ€åŠ è½½ API å’Œå¤–éƒ¨åº“ -->
  <script>
    // æå‰å ä½ï¼Œé¿å… Google å›è°ƒåˆ°æœªå®šä¹‰å‡½æ•°å¯¼è‡´ InvalidValueError
    window.initGoogleMapsAPI = window.initGoogleMapsAPI || function () {
      // å ä½ï¼šçœŸæ­£é€»è¾‘åœ¨åº•éƒ¨é‡æ–°èµ‹å€¼
      console.log('[å ä½] initGoogleMapsAPI æ—©æœŸè§¦å‘');
    };

    // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾ API
    (function () {
      const amapScript = document.createElement('script');
      amapScript.src = API_CONFIG.getAmapUrl();
      document.head.appendChild(amapScript);
    })();

    // åŠ¨æ€åŠ è½½ Google Maps API
    (function () {
      const googleScript = document.createElement('script');
      googleScript.src = API_CONFIG.getGoogleMapsUrl('initGoogleMapsAPI');
      googleScript.async = true;
      googleScript.defer = true;
      document.head.appendChild(googleScript);
    })();

    // åŠ¨æ€åŠ è½½ Marked.js
    (function () {
      const markedScript = document.createElement('script');
      markedScript.src = API_CONFIG.libraries.marked;
      document.head.appendChild(markedScript);
    })();

    // åŠ¨æ€åŠ è½½ SheetJS
    (function () {
      const sheetjsScript = document.createElement('script');
      sheetjsScript.src = API_CONFIG.libraries.sheetjs;
      document.head.appendChild(sheetjsScript);
    })();

    // åŠ¨æ€åŠ è½½ Chart.js
    (function () {
      const chartjsScript = document.createElement('script');
      chartjsScript.src = API_CONFIG.libraries.chartjs;
      document.head.appendChild(chartjsScript);
    })();

    // åŠ¨æ€åŠ è½½ html2canvas
    (function () {
      const h2cScript = document.createElement('script');
      h2cScript.src = API_CONFIG.libraries.html2canvas;
      document.head.appendChild(h2cScript);
    })();
  </script>
  <link rel="stylesheet" href="css/app.css">
</head>

<body>

  <!-- é¡¶éƒ¨æ¨¡å¼åˆ‡æ¢ -->
  <div id="topbar">
    <div id="mainNavGroup"
      style="display:flex; gap:6px; background:linear-gradient(135deg, rgba(13,110,253,0.12), rgba(99,179,237,0.12)); padding:4px 6px; border:1px solid var(--border-color); border-radius:8px;">
      <a href="index.html" id="goHomeBtn" class="mode-btn"
        style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">ğŸ  ä¸»é¡µ</a>
      <button id="modeTrainBtn" class="mode-btn">ğŸš† ç«è½¦</button>
      <button id="modePlaneBtn" class="mode-btn">âœˆï¸ é£æœº</button>
    </div>
    <button id="sidebarToggleBtn" class="mode-btn" style="margin-left:auto;">éšè—ä¾§è¾¹æ </button>
  </div>

  <!-- Sidebar: Form + Theme Toggle -->
  <div id="sidebar">
    <button id="themeToggle">åˆ‡æ¢æš—è‰²æ¨¡å¼</button>

    <select id="mapSelect"
      style="width:100%; padding:8px; margin-bottom:10px; border-radius:4px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color);">
      <option value="amap">ğŸ—ºï¸ é«˜å¾·åœ°å›¾ (Amap)</option>
      <option value="google">ğŸ—ºï¸ è°·æ­Œåœ°å›¾ (Google)</option>
      <option value="leaflet">ğŸ—ºï¸ CartoDB (OpenStreetMap)</option>
    </select>
    <script>
      // Initialize mapSelect value immediately to prevent flash
      (function () {
        const savedMap = localStorage.getItem('currentMapType') || 'amap';
        const sel = document.getElementById('mapSelect');
        if (sel) sel.value = savedMap;
      })();
    </script>
    <h2 id="sectionTitle" style="margin-top:10px;">ç«è½¦ç¥¨è®°å½•</h2>

    <!-- åˆ†ç»„ï¼šåœ°å›¾çº¿è·¯ & åŠ¨ç”» -->
    <div class="sidebar-group">
      <h4>ğŸ›° è·¯çº¿ç»˜åˆ¶ / å›æ”¾</h4>
      <p class="sidebar-group-desc">ä½¿ç”¨å†…ç½®ç¼“å­˜é¿å…é‡å¤åœ°ç†ç¼–ç ï¼›æ”¯æŒå¼ºåˆ¶é‡ç®—ä¸æŒ‰é¡ºåºåŠ¨ç”»å›æ”¾ã€‚</p>
      <div class="sidebar-btn-row">
        <button id="forceRedrawBtn"
          style="flex:1; padding:7px; font-size:11px; background:#343a40; color:#fff; border:none; border-radius:3px; cursor:pointer;"
          title="æ¸…é™¤å·²ç¼“å­˜è·¯å¾„å¹¶é‡æ–°é€æ¡è®¡ç®—">â™»ï¸ é‡æ–°ç»˜åˆ¶çº¿è·¯</button>
        <button id="replayBtn"
          style="flex:1; padding:7px; font-size:11px; background:#198754; color:#fff; border:none; border-radius:3px; cursor:pointer;"
          title="æ‰“å¼€åŠ¨ç”»é®ç½©ï¼ŒæŒ‰é¡ºåºå›æ”¾å·²ç¼“å­˜è·¯å¾„">â–¶ï¸ åŠ¨ç”»å›æ”¾</button>
      </div>
      <div id="pathErrorBox"
        style="margin-top:8px; display:none; background:#fff3cd; color:#664d03; border:1px solid #ffe69c; padding:6px 8px; border-radius:4px; max-height:120px; overflow-y:auto; font-size:11px; line-height:1.4;">
        <div style="font-weight:600; margin-bottom:4px;">âš ï¸ çº¿è·¯ç»˜åˆ¶å¤±è´¥</div>
        <ul id="pathErrorList" style="margin:0; padding-left:18px;"></ul>
        <button id="clearPathErrorsBtn"
          style="margin-top:4px; width:100%; background:#ffc107; border:none; border-radius:3px; padding:4px 6px; cursor:pointer; font-size:11px;">æ¸…é™¤æç¤º</button>
      </div>
    </div>

    <!-- åˆ†ç»„ï¼šæ™ºèƒ½é—®ç­” -->
    <div class="sidebar-group">
      <h4>ğŸ¤– æ™ºèƒ½é—®ç­”</h4>
      <p class="sidebar-group-desc">åŸºäºå½“å‰è¡¨æ ¼æ•°æ®ï¼Œå‘ AI æé—®ã€‚</p>
      <div class="sidebar-btn-row">
        <button id="askGeminiBtn"
          style="flex:1; padding:7px; font-size:11px; background:#6610f2; color:#fff; border:none; border-radius:3px; cursor:pointer;">âœ¨
          è¯¢é—® AI</button>
      </div>
    </div>

    <!-- åˆ†ç»„ï¼šå¹´åº¦æŠ¥å‘Š -->
    <div class="sidebar-group">
      <h4>ğŸ“… å¹´åº¦å‡ºè¡ŒæŠ¥å‘Š</h4>
      <p class="sidebar-group-desc">ç”Ÿæˆç±»ä¼¼â€œå¹´åº¦å¬æ­ŒæŠ¥å‘Šâ€çš„é•¿å›¾ï¼Œå›é¡¾æ‚¨çš„å¹´åº¦è¶³è¿¹ã€‚</p>
      <div class="sidebar-btn-row">
        <button id="yearlyReportBtn"
          style="flex:1; padding:7px; font-size:11px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:3px; cursor:pointer;">âœ¨
          ç”Ÿæˆå¹´åº¦æŠ¥å‘Š</button>
      </div>
    </div>

    <!-- åˆ†ç»„ï¼šæ•°æ®å¯¼å…¥ / å¯¼å‡º -->
    <div class="sidebar-group">
      <h4>ğŸ“¥ æ•°æ®å¯¼å…¥ / å¯¼å‡º</h4>
      <p class="sidebar-group-desc">è¡¨æ ¼æ•°æ®åŒå‘æµè½¬ï¼šä»å¤–éƒ¨æ–‡ä»¶å¯¼å…¥ï¼Œæˆ–å°†å½“å‰æ•°æ®åˆ†äº«/å¤‡ä»½ã€‚</p>
      <div class="sidebar-btn-row">
        <button id="importCsvBtn"
          style="flex:1; padding:7px; font-size:11px; background:#fd7e14; color:#fff; border:none; border-radius:3px; cursor:pointer;">ğŸ“„
          å¯¼å…¥CSV</button>
        <button id="exportCsvBtn"
          style="flex:1; padding:7px; font-size:11px; background:#28a745; color:#fff; border:none; border-radius:3px; cursor:pointer;">ğŸ’¾
          å¯¼å‡ºCSV</button>
      </div>
      <div class="sidebar-btn-row">
        <button id="importExcelBtn"
          style="flex:1; padding:7px; font-size:11px; background:#17a2b8; color:#fff; border:none; border-radius:3px; cursor:pointer;">ğŸ“Š
          å¯¼å…¥Excel</button>
        <button id="exportJsonBtn"
          style="flex:1; padding:7px; font-size:11px; background:#6f42c1; color:#fff; border:none; border-radius:3px; cursor:pointer;">ğŸ“‹
          å¯¼å‡ºJSON</button>
      </div>
    </div>

    <!-- åˆ†ç»„ï¼šå¤‡ä»½ / æ¢å¤ -->
    <div class="sidebar-group">
      <h4>ğŸ›¡ æ•°æ®å¤‡ä»½ / æ¢å¤</h4>
      <p class="sidebar-group-desc">å®Œæ•´ä¿å­˜ <small class="code-tag">records + è§†å›¾è®¾ç½®</small>ï¼Œè¿ç§»æˆ–é‡è£…æµè§ˆå™¨æ—¶å¿«é€Ÿæ¢å¤ã€‚</p>
      <div class="sidebar-btn-row">
        <button id="backupBtn"
          style="flex:1; padding:7px; font-size:11px; background:#dc3545; color:#fff; border:none; border-radius:3px; cursor:pointer;">ğŸ’¾
          å¤‡ä»½æ•°æ®</button>
        <button id="restoreBtn"
          style="flex:1; padding:7px; font-size:11px; background:#ffc107; color:#111; border:none; border-radius:3px; cursor:pointer;">ğŸ“¤
          æ¢å¤æ•°æ®</button>
      </div>
    </div>

    <!-- åˆ†ç»„ï¼šå¸®åŠ© / è¯´æ˜ -->
    <div class="sidebar-group">
      <h4>â“ å¸®åŠ© / è¯´æ˜</h4>
      <p class="sidebar-group-desc">æŸ¥çœ‹å®Œæ•´åŠŸèƒ½åˆ—è¡¨ä¸ä½¿ç”¨æŠ€å·§ã€‚</p>
      <div class="sidebar-btn-row">
        <button id="featuresHelpBtn"
          style="flex:1; padding:7px; font-size:11px; background:#343a40; color:#fff; border:none; border-radius:3px; cursor:pointer;">ğŸ“˜
          åŠŸèƒ½è¯´æ˜</button>
      </div>
    </div>

    <input type="file" id="importCsvFile" accept=".csv" style="display: none;">
    <input type="file" id="importExcelFile" accept=".xlsx,.xls" style="display: none;">
    <input type="file" id="restoreFile" accept=".json" style="display: none;">

    <div id="modeIndicator">å½“å‰æ“ä½œï¼šè¡Œå†…ç¼–è¾‘</div>
    <div id="form"></div>
  </div>

  <!-- Main Area: Summary + Map + Table -->
  <div id="main">
    <div id="container">
      <!-- åœ°å›¾å®¹å™¨ -->
      <div id="mapContainer"></div>
      <!-- åœ°ç‚¹æ ‡è®°æŒ‰é’®å·²ç§»é™¤ -->
      <!-- å¹´ä»½å›¾ä¾‹åœ¨åœ°å›¾å³ä¸‹è§’ -->
      <div id="yearLegend">
        <h4>å¹´ä»½å›¾ä¾‹</h4>
        <div id="legendContent"></div>
      </div>
    </div>

    <!-- æ€»ç»“é¢æ¿ -->
    <div id="summaryPanel">
      <div class="summary-tabs">
        <button class="summary-tab active" data-tab="all">å†å²æ€»ç»“</button>
        <button class="summary-tab" data-tab="yearly">å¹´åº¦æ€»ç»“</button>
      </div>

      <!-- å†å²æ€»ç»“å†…å®¹ -->
      <div id="allSummary" class="summary-content active">
        <div class="stats-grid" id="allStatsGrid">
          <!-- ç»Ÿè®¡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- å¹´åº¦æ€»ç»“å†…å®¹ -->
      <div id="yearlySummary" class="summary-content">
        <div class="year-selector">
          <select id="yearSelect">
            <option value="">è¯·é€‰æ‹©å¹´ä»½</option>
          </select>
        </div>
        <div class="stats-grid" id="yearlyStatsGrid">
          <!-- ç»Ÿè®¡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- å›¾è¡¨é¢æ¿ -->
    <div id="chartsPanel">
      <div class="charts-grid">
        <div class="chart-container">
          <div class="chart-title">å¹´åº¦ä¹˜è½¦æ¬¡æ•°</div>
          <canvas id="tripsChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">å¹´åº¦é‡Œç¨‹ (å…¬é‡Œ)</div>
          <canvas id="distanceChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">å¹´åº¦èŠ±è´¹ (å…ƒ)</div>
          <canvas id="costChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">å¹´åº¦ä¹˜è½¦æ—¶é•¿ (å°æ—¶)</div>
          <canvas id="durationChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title" id="bureauChartTitle">é“è·¯å±€ç»Ÿè®¡</div>
          <canvas id="bureauChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title" id="typeChartTitle">è½¦å‹ç»Ÿè®¡</div>
          <canvas id="typeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ç»Ÿè®¡é¢æ¿ -->
    <div id="statsPanel"
      style="margin-bottom: 15px; padding: 10px; background: var(--form-bg); border: 1px solid var(--border-color); border-radius: 5px;">
      <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-color);">ğŸ“Š å‡ºè¡Œç»Ÿè®¡</h4>

      <!-- è·¯çº¿çƒ­åŠ›å›¾ -->
      <div id="routeHeatmap" style="margin-bottom: 15px; align-self: stretch;">
        <h5 style="margin: 0 0 8px 0; font-size: 12px; color: var(--text-color);">ğŸ”¥ çƒ­é—¨è·¯çº¿</h5>
        <div id="routeList" style="max-height: 260px; overflow-y: auto; font-size: 11px;"></div>
      </div>

      <!-- åœ°åŒºç»Ÿè®¡ -->
      <div id="regionStats" style="align-self: stretch;">
        <h5 style="margin: 0 0 8px 0; font-size: 12px; color: var(--text-color);">ğŸ—ºï¸ åˆ°è®¿åŸå¸‚</h5>
        <div id="cityList" style="max-height: 260px; overflow-y: auto; font-size: 11px;"></div>
      </div>
    </div>

    <!-- Map container moved to top -->

    <!-- åŠ¨ç”»å›æ”¾åœ°å›¾é®ç½© -->
    <div id="replayOverlay"
      style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
      <div
        style="width:88%; height:85%; background:var(--bg-color); border:1px solid var(--border-color); border-radius:10px; display:grid; grid-template-columns: 260px 1fr; grid-template-rows:auto 1fr; overflow:hidden; box-shadow:0 6px 24px rgba(0,0,0,.35);">
        <!-- å¤´éƒ¨å·¥å…·æ¡ -->
        <div
          style="grid-column:1 / -1; display:flex; align-items:center; gap:10px; padding:8px 14px; background:var(--table-head-bg); border-bottom:1px solid var(--border-color);">
          <strong style="flex:1; letter-spacing:.5px;">çº¿è·¯åŠ¨ç”»å›æ”¾</strong>
          <button id="replayCloseBtn" class="replay-ctrl-btn" style="background:#dc3545; color:#fff;">å…³é—­</button>
        </div>
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div
          style="padding:12px 14px; display:flex; flex-direction:column; gap:10px; background:var(--sidebar-bg); border-right:1px solid var(--border-color); font-size:12px;">
          <div id="replaySourceBox"
            style="font-size:11px; line-height:1.5; background:var(--form-bg); border:1px solid var(--border-color); padding:10px 10px; border-radius:6px; display:flex; flex-direction:column; gap:6px;">
            <div style="font-weight:600;">æ•°æ®æ¥æº</div>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px;">
              <input type="radio" name="replaySource" value="train" style="margin:0;"> ğŸš† ç«è½¦è®°å½•
            </label>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px;">
              <input type="radio" name="replaySource" value="plane" style="margin:0;"> âœˆï¸ é£æœºè®°å½•
            </label>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px;">
              <input type="radio" name="replaySource" value="all" checked style="margin:0;"> ğŸŒ å…¨éƒ¨ (æŒ‰æ—¶é—´åˆå¹¶)
            </label>
          </div>
          <div id="replayModeBox"
            style="font-size:11px; line-height:1.5; background:var(--form-bg); border:1px solid var(--border-color); padding:10px 10px; border-radius:6px; display:flex; flex-direction:column; gap:6px;">
            <div style="font-weight:600;">æ’­æ”¾æ¨¡å¼</div>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px;">
              <input type="radio" name="replayMode" value="all" checked style="margin:0;"> å…¨éƒ¨å¹´ä»½æ’­æ”¾
            </label>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px;">
              <input type="radio" name="replayMode" value="sequential" style="margin:0;"> é€å¹´ä¾æ¬¡æ’­æ”¾ (å¹´ä¸å¹´ä¹‹é—´æ¸…ç©º)
            </label>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px;">
              <input type="radio" name="replayMode" value="single" style="margin:0;"> æŒ‡å®šå¹´ä»½æ’­æ”¾
              <select id="replayYearSelect" disabled
                style="padding:3px 6px; font-size:11px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color); border-radius:4px;">
                <option value="">é€‰æ‹©å¹´ä»½</option>
              </select>
            </label>
            <div style="opacity:.65;">æç¤ºï¼šå¼€å§‹åå¯æš‚åœï¼›é€å¹´æ¨¡å¼æ¯å¹´ç»“æŸåè‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€å¹´ã€‚</div>
            <div style="opacity:.8;">å½“å‰ï¼š<span id="replayYearModeHint"
                style="color:var(--primary-color); font-weight:600;">å…¨éƒ¨å¹´ä»½</span></div>
          </div>

          <!-- æ’­æ”¾è®¾ç½®ï¼šé€Ÿåº¦ä¸ç²—ç»† -->
          <div id="replaySettingsBox"
            style="font-size:11px; line-height:1.5; background:var(--form-bg); border:1px solid var(--border-color); padding:10px 10px; border-radius:6px; display:flex; flex-direction:column; gap:8px;">
            <div style="font-weight:600;">æ’­æ”¾è®¾ç½®</div>

            <!-- é€Ÿåº¦ -->
            <div style="display:flex; flex-direction:column; gap:2px;">
              <div style="display:flex; justify-content:space-between;">
                <span>ç»˜åˆ¶é€Ÿåº¦</span>
                <span id="replaySpeedValue">x1.0</span>
              </div>
              <input type="range" id="replaySpeedInput" min="10" max="100" value="30" step="10"
                style="width:100%; cursor:pointer;">
            </div>

            <!-- ç²—ç»† -->
            <div style="display:flex; flex-direction:column; gap:2px;">
              <div style="display:flex; justify-content:space-between;">
                <span>çº¿æ¡ç²—ç»†</span>
                <span id="replayWidthValue">1px</span>
              </div>
              <input type="range" id="replayWidthInput" min="0.1" max="3" value="1" step="0.1"
                style="width:100%; cursor:pointer;">
            </div>
          </div>
          <!-- æ“ä½œæŒ‰é’®ï¼šå¼€å§‹ / æš‚åœ / é‡ç½® -->
          <div id="replayActionBar" style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="replayBtnStart" class="replay-ctrl-btn" style="flex:1;">å¼€å§‹</button>
            <button id="replayBtnPause" class="replay-ctrl-btn" style="flex:1;">æš‚åœ</button>
            <button id="replayBtnReset" class="replay-ctrl-btn" style="flex:1;">é‡ç½®</button>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; margin-top:4px;">
            <div style="display:flex; justify-content:space-between; font-size:11px;">
              <span>å½“å‰å¹´ä»½è¿›åº¦</span>
              <span><span id="replayYearProgressCnt">0</span>/<span id="replayYearProgressTotal">0</span></span>
            </div>
            <div style="height:6px; background:var(--table-head-bg); border-radius:4px; overflow:hidden;">
              <div id="replayYearProgressBar"
                style="height:100%; width:0%; background:linear-gradient(90deg, var(--primary-color), #42c3ff); transition:width .25s;">
              </div>
            </div>
          </div>
          <div style="margin-top:auto; font-size:11px; opacity:.55;">ESC å…³é—­ï¼›ç©ºæ ¼æš‚åœ/ç»§ç»­</div>
        </div>
        <!-- å³ä¾§åœ°å›¾ + æ€»ä½“çŠ¶æ€ -->
        <div style="display:flex; flex-direction:column; position:relative;">
          <div
            style="padding:6px 12px; font-size:12px; line-height:1.4; color:var(--text-color); border-bottom:1px solid var(--border-color); display:flex; flex-wrap:wrap; gap:16px;">
            <div>æ€»è·¯çº¿ï¼š<span id="replayTotal">0</span></div>
            <div>å·²èµ°ï¼š<span id="replayProgress">0</span></div>
            <div id="replayStatus" style="color:#0d6efd;">å‡†å¤‡å°±ç»ª</div>
          </div>
          <div style="position:relative; flex:1; width:100%; height:100%;">
            <div id="replayMap" style="width:100%; height:100%;"></div>

            <!-- Color Legend for All mode -->
            <div id="replayColorLegend" style="position:absolute; top:10px; left:10px; 
                        background:var(--modal-bg); 
                        backdrop-filter: blur(5px);
                        border:1px solid var(--border-color); 
                        border-radius:6px; 
                        box-shadow:0 2px 8px rgba(0,0,0,0.15); 
                        padding:8px 10px; 
                        z-index:1010;
                        font-size:11px;
                        display:none;">
              <div style="font-weight:600; margin-bottom:4px; color:var(--text-color);">è·¯çº¿é¢œè‰²</div>
              <div style="display:flex; align-items:center; gap:6px; margin-bottom:2px;">
                <div style="width:20px; height:3px; background:#F44336; border-radius:2px;"></div>
                <span style="color:var(--text-color);">ç«è½¦</span>
              </div>
              <div style="display:flex; align-items:center; gap:6px;">
                <div style="width:20px; height:3px; background:#2196F3; border-radius:2px;"></div>
                <span style="color:var(--text-color);">é£æœº</span>
              </div>
            </div>

            <!-- æ‚¬æµ®ä¿¡æ¯é¢æ¿ -->
            <div id="replayFloatingInfo" style="position:absolute; bottom:20px; right:20px; width:280px; max-height:320px; 
                        background:var(--modal-bg); 
                        backdrop-filter: blur(5px);
                        border:1px solid var(--border-color); 
                        border-radius:8px; 
                        box-shadow:0 4px 16px rgba(0,0,0,0.2); 
                        padding:10px; 
                        z-index:1010; 
                        display:flex; flex-direction:column; gap:8px;
                        font-size:11px;">

              <!-- å½“å‰çº¿è·¯ -->
              <div
                style="background:var(--form-bg, rgba(0,0,0,0.03)); padding:8px; border-radius:6px; border:1px solid var(--border-color);">
                <div style="font-weight:600; margin-bottom:4px; color:var(--text-color);">ç´¯è®¡æ•°æ®</div>
                <div id="replayCurrentRoute" style="word-break:break-all; opacity:.9; color:var(--text-color);">â€”</div>
              </div>

              <!-- çº¿è·¯åˆ—è¡¨ -->
              <div
                style="flex:1; display:flex; flex-direction:column; background:var(--form-bg, rgba(0,0,0,0.03)); padding:8px; border-radius:6px; border:1px solid var(--border-color); min-height:100px; overflow:hidden;">
                <div style="font-weight:600; margin-bottom:6px; color:var(--text-color); flex-shrink:0;">çº¿è·¯åˆ—è¡¨ (ç´¯è®¡)</div>
                <div style="flex:1; overflow-y:auto; padding-right:2px;">
                  <ul id="replayRouteList"
                    style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:4px;"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <table id="historyTable">
      <thead>
        <tr>
          <th>#</th>
          <th class="sortable" data-field="date">æ—¥æœŸ</th>
          <th class="sortable" data-field="time">æ—¶é—´</th>
          <th class="sortable" data-field="duration">æ—¶é•¿</th>
          <th class="sortable" data-field="trainNo" id="th-trainNo">è½¦æ¬¡</th>
          <th class="sortable" data-field="startStation" id="th-startStation">èµ·ç‚¹ç«™</th>
          <th class="sortable" data-field="startCity" id="th-startCity">èµ·ç‚¹åŸå¸‚</th>
          <th class="sortable" data-field="endStation" id="th-endStation">ç»ˆç‚¹ç«™</th>
          <th class="sortable" data-field="endCity" id="th-endCity">ç»ˆç‚¹åŸå¸‚</th>
          <th class="sortable" data-field="seatClass" id="th-seatClass">åº§å¸­</th>
          <th class="sortable" data-field="trainType" id="th-trainType">è½¦å‹å·</th>
          <th class="sortable" data-field="bureau" id="th-bureau">é“è·¯å±€</th>
          <th class="sortable" data-field="cost">è´¹ç”¨</th>
          <th class="sortable" data-field="distance">é‡Œç¨‹</th>
          <th class="sortable" data-field="rpk">RMB/km</th>
          <th class="sortable" data-field="speed">km/h</th>
          <th>å¤‡æ³¨</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin: 8px 0 0;">
      <button id="addRowBtn"
        style="padding:6px 10px;font-size:12px;border:1px solid var(--border-color);background:var(--btn-bg);color:var(--text-color);border-radius:4px;cursor:pointer;">â•
        æ–°å¢ä¸€è¡Œ</button>
    </div>
  </div>


  <!-- å¹´åº¦æŠ¥å‘Š Modal -->
  <div id="reportModalOverlay"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:3000; align-items:center; justify-content:center; overflow-y:auto;">
    <div
      style="background:transparent; width:100%; max-width:480px; margin:20px auto; display:flex; flex-direction:column; align-items:center;">

      <!-- æ§åˆ¶æ  -->
      <div
        style="background:var(--modal-bg); padding:10px 15px; border-radius:10px; margin-bottom:15px; display:flex; gap:10px; width:100%; box-sizing:border-box; box-shadow:0 4px 12px rgba(0,0,0,0.3);">
        <select id="reportYearSelect"
          style="flex:1; padding:8px; border-radius:5px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color);">
          <option value="">é€‰æ‹©å¹´ä»½...</option>
        </select>
        <button id="generateReportBtn"
          style="padding:8px 15px; background:var(--primary-color); color:#fff; border:none; border-radius:5px; cursor:pointer;">ç”Ÿæˆ</button>
        <button id="closeReportBtn"
          style="padding:8px 15px; background:var(--btn-bg); color:var(--text-color); border:1px solid var(--border-color); border-radius:5px; cursor:pointer;">å…³é—­</button>
      </div>

      <!-- æŠ¥å‘Šé¢„è§ˆåŒºåŸŸ (å°†è¢«æˆªå›¾) -->
      <div id="reportContent"
        style="width:100%; background:#fff; border-radius:0; overflow:hidden; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹å°†å¡«å……åœ¨è¿™é‡Œ -->
        <div style="padding:40px; text-align:center; color:#666;">è¯·é€‰æ‹©å¹´ä»½å¹¶ç‚¹å‡»ç”Ÿæˆ</div>
      </div>

      <!-- åº•éƒ¨æ“ä½œ -->
      <div style="margin-top:15px; display:flex; gap:10px;">
        <button id="saveReportImgBtn"
          style="padding:10px 20px; background:#28a745; color:#fff; border:none; border-radius:30px; font-weight:bold; cursor:pointer; box-shadow:0 4px 12px rgba(40,167,69,0.4); display:none;">ğŸ’¾
          ä¿å­˜ä¸ºå›¾ç‰‡</button>
      </div>
    </div>
  </div>

  <!-- åŠŸèƒ½è¯´æ˜ Modal -->
  <div id="featuresHelpOverlay">
    <div id="featuresHelpModal">
      <button id="featuresHelpClose">&times;</button>
      <h3>åŠŸèƒ½æ€»è§ˆä¸ä½¿ç”¨è¯´æ˜</h3>
      <!-- å†…å®¹ç”± js/features_help.js åŠ¨æ€åŠ è½½ -->
    </div>
  </div>


  <!-- Gemini Q&A Modal -->
  <div id="geminiQAModalOverlay"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div
      style="background:var(--modal-bg); width:90%; max-width:600px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:80vh;">
      <div
        style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--text-color);">âœ¨ è¯¢é—® AI</h3>
        <button id="geminiQACloseBtn"
          style="background:none; border:none; font-size:20px; cursor:pointer; color:var(--text-color);">&times;</button>
      </div>
      <div style="padding:15px; flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
        <div id="geminiQAChatHistory"
          style="flex:1; min-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:4px; padding:10px; background:var(--bg-color); margin-bottom:10px;">
          <div style="color:var(--text-color); opacity:0.7; text-align:center; margin-top:20px;">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒAI
            å°†æ ¹æ®å½“å‰è¡¨æ ¼æ•°æ®è¿›è¡Œå›ç­”ã€‚</div>
        </div>
        <div style="display:flex; gap:10px;">
          <input type="text" id="geminiQAInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä»Šå¹´å»äº†å“ªäº›åŸå¸‚ï¼ŸèŠ±è´¹æœ€å¤šçš„æ˜¯å“ªæ¬¡ï¼Ÿ"
            style="flex:1; padding:8px; border:1px solid var(--input-border); border-radius:4px; background:var(--input-bg); color:var(--text-color); user-select:text; -webkit-user-select:text; pointer-events:auto;"
            onkeydown="event.stopPropagation()" onkeypress="event.stopPropagation()"
            onmousedown="event.stopPropagation()" onclick="this.focus(); event.stopPropagation()">
          <button id="geminiQASendBtn"
            style="padding:8px 15px; background:var(--primary-color); color:#fff; border:none; border-radius:4px; cursor:pointer;">å‘é€</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script src="js/features_help.js"></script>
</body>

</html>