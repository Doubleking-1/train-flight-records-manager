<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <style>
    /* Feature Help Modal Styles */
    #featuresHelpOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }

    #featuresHelpModal {
      background: var(--panel-bg);
      color: var(--text);
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      position: relative;
    }

    #featuresHelpModal h3 {
      margin-top: 0;
      border-bottom: 2px solid var(--border);
      padding-bottom: 12px;
      margin-bottom: 20px;
    }

    #featuresHelpModal button#featuresHelpClose {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text);
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    #featuresHelpModal button#featuresHelpClose:hover {
      opacity: 1;
    }

    #featuresHelpModal li {
      margin-bottom: 12px;
      line-height: 1.6;
    }
  </style>
  <title>å‡ºè¡Œé¦–é¡µæ¦‚è§ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet for OSM support -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- å¼•å…¥ API é…ç½®æ–‡ä»¶ -->
  <script src="js/config.js"></script>
  <!-- åŠ¨æ€åŠ è½½åœ°å›¾ API -->
  <script>
    // æ ‡è®° API åŠ è½½çŠ¶æ€
    window.amapLoaded = false;

    // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾ API
    (function () {
      const amapScript = document.createElement('script');
      amapScript.src = API_CONFIG.getAmapUrl();
      amapScript.onload = function () {
        window.amapLoaded = true;
        console.log('âœ… é«˜å¾·åœ°å›¾ API åŠ è½½å®Œæˆ');
      };
      amapScript.onerror = function () {
        console.error('âŒ é«˜å¾·åœ°å›¾ API åŠ è½½å¤±è´¥');
      };
      document.head.appendChild(amapScript);
    })();

    // åŠ¨æ€åŠ è½½ Google Maps API
    (function () {
      const googleScript = document.createElement('script');
      googleScript.src = API_CONFIG.getGoogleMapsUrl('initGoogleAPI');
      googleScript.async = true;
      googleScript.defer = true;
      document.head.appendChild(googleScript);
    })();

    // åŠ¨æ€åŠ è½½ marked.js
    (function () {
      const markedScript = document.createElement('script');
      markedScript.src = API_CONFIG.libraries.marked;
      document.head.appendChild(markedScript);
    })();
  </script>
  <link rel="stylesheet" href="css/index.css">
</head>

<body>
  <div id="sidebar">
    <div class="card" style="margin-top:4px;">
      <h2 style="margin:0 0 10px; font-size:17px;">å‡ºè¡Œæ¦‚è§ˆ</h2>
      <div class="flex" style="margin-bottom:10px;">
        <button id="toggleThemeBtn" style="flex:1;">æš—è‰²æ¨¡å¼</button>
        <a href="app.html" class="nav-link" style="flex:1;">è¿›å…¥ç®¡ç†é¡µé¢ âœ</a>
      </div>
      <select id="mapSelect"
        style="width:100%; padding:8px; margin-bottom:10px; border-radius:4px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:13px;">
        <option value="amap">ğŸ—ºï¸ é«˜å¾·åœ°å›¾ (Amap)</option>
        <option value="google">ğŸ—ºï¸ è°·æ­Œåœ°å›¾ (Google)</option>
        <option value="leaflet">ğŸ—ºï¸ CartoDB (OpenStreetMap)</option>
      </select>
      <script>
        // ç«‹å³åˆå§‹åŒ–åœ°å›¾é€‰æ‹©å™¨å€¼
        (function () {
          const savedMap = localStorage.getItem('currentMapType') || 'amap';
          const sel = document.getElementById('mapSelect');
          if (sel) sel.value = savedMap;
        })();
      </script>
      <p style="margin:0; font-size:11px; line-height:1.5; opacity:.7;">å±•ç¤ºç«è½¦ä¸é£æœºè¡Œç¨‹çš„æ€»ä½“é‡Œç¨‹ä¸æ•°é‡æ¦‚è§ˆï¼Œæ”¯æŒä¸€é”®æ•°æ®å¤‡ä»½ / æ¢å¤ã€‚</p>
    </div>
    <div class="card">
      <h3>ğŸ”¥ æ±‡æ€»ç»Ÿè®¡</h3>
      <div class="stats-grid" id="summaryStats"></div>
      <div style="margin-top:10px; font-size:11px; opacity:.7;" id="lastUpdateInfo">â€”</div>
    </div>
    <div class="card">
      <h3>ğŸ¤– æ™ºèƒ½é—®ç­”</h3>
      <p style="margin:0 0 10px; font-size:11px; line-height:1.5; opacity:.7;">åŸºäºæ‰€æœ‰è¡Œç¨‹æ•°æ®ï¼ˆç«è½¦+é£æœºï¼‰ï¼Œå‘ AI æé—®ã€‚</p>
      <div style="display:flex; gap:8px;">
        <button id="askGeminiBtn"
          style="flex:2; padding:8px; background:#6610f2; color:#fff; border:none; border-radius:4px; cursor:pointer;">âœ¨
          è¯¢é—® AI</button>
        <button id="aiSettingsBtn"
          style="flex:1; padding:0 8px; background:rgba(0,0,0,0.05); color:var(--text); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;"
          onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'"
          title="é…ç½® AI">âš™ï¸ é…ç½®</button>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ›  æ•°æ®æ“ä½œ</h3>
      <div class="flex">
        <button id="refreshBtn" class="primary" style="flex:1;">åˆ·æ–°</button>
        <button id="clearCacheBtn" class="danger" style="flex:1;">æ¸…ç¼“å­˜</button>
      </div>
      <div class="flex" style="margin-top:8px;">
        <button id="backupAllBtn" style="flex:1;">ğŸ“¦ ä¸€é”®å¤‡ä»½å…¨éƒ¨</button>
        <button id="restoreAllBtn" style="flex:1;">ğŸ“¤ æ¢å¤</button>
      </div>

      <!-- Cloud Sync Buttons -->
      <div class="flex" style="margin-top:8px; border-top:1px solid var(--border-color); padding-top:8px;">
        <button id="cloudSettingsBtn" style="flex:1; background:#6c757d; color:#fff;">â˜ï¸ é…ç½®åŒæ­¥</button>
        <button id="cloudUploadBtn" style="flex:1; background:#0d6efd; color:#fff;">â¬†ï¸ ä¸Šä¼ äº‘ç«¯</button>
        <button id="cloudDownloadBtn" style="flex:1; background:#198754; color:#fff;">â¬‡ï¸ ä¸‹è½½äº‘ç«¯</button>
      </div>
      <input type="file" id="restoreAllFile" accept=".json" style="display:none;" />
      <p style="margin:10px 0 6px; font-size:11px; line-height:1.5; opacity:.8;">æœ¬é¡µå±•ç¤ºç«è½¦ä¸é£æœºä¸¤å¥—æ•°æ®çš„å¿«é€Ÿæ¦‚è§ˆä¸åœ°å›¾ç¼©ç•¥å›¾ã€‚è¯¦ç»†ç¼–è¾‘è¯·è¿›å…¥ç®¡ç†é¡µé¢ã€‚
      </p>

      <!-- Feature Help Button -->
      <div class="flex" style="margin-top:12px; border-top:1px solid var(--border-color); padding-top:10px;">
        <button id="featuresHelpBtn"
          style="flex:1; padding:7px; font-size:11px; background:#343a40; color:#fff; border:none; border-radius:3px; cursor:pointer;">ğŸ“˜
          åŠŸèƒ½è¯´æ˜</button>
      </div>
    </div>
  </div>
  <div id="main">
    <div id="mapsWrap">
      <div class="map-panel map-panel-full">
        <h4><span class="legend-dot train"></span><span class="legend-dot plane"></span>ğŸŒ åˆå¹¶è§†å›¾</h4>
        <div id="combinedMap" class="map"></div>
      </div>
      <div class="map-panel">
        <h4><span class="legend-dot train"></span>ğŸš„ ç«è½¦çº¿è·¯</h4>
        <div id="trainMap" class="map"></div>
      </div>
      <div class="map-panel">
        <h4><span class="legend-dot plane"></span>âœˆï¸ é£æœºçº¿è·¯</h4>
        <div id="planeMap" class="map"></div>
      </div>
    </div>
    <div id="footerBar">
      <span>åŒæ­¥æ˜¾ç¤ºä¸¤ç§äº¤é€šæ–¹å¼çš„å·²ç¼“å­˜çº¿è·¯ (ä»…å±•ç¤ºå·²æœ‰ pathWGS è®°å½•)</span>
      <span id="statusPill" class="pill">å‡†å¤‡</span>
    </div>
  </div>
  <!-- Cloud Sync Settings Modal -->
  <div id="cloudSettingsModalOverlay"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
    <div
      style="background:var(--panel); padding:20px; border-radius:8px; width:90%; max-width:400px; border:1px solid var(--border); box-shadow:0 4px 12px rgba(0,0,0,0.25);">
      <h3 style="margin-top:0; color:var(--text); font-size:16px;">â˜ï¸ äº‘ç«¯åŒæ­¥é…ç½® (JSONBin)</h3>
      <p style="font-size:12px; color:var(--text); opacity:0.7; line-height:1.5;">
        è¯·å‰å¾€ <a href="https://jsonbin.io" target="_blank" style="color:var(--accent);">jsonbin.io</a> æ³¨å†Œå¹¶è·å– API Keyã€‚<br>
        Bin ID å¯ç•™ç©ºï¼Œé¦–æ¬¡ä¸Šä¼ æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºã€‚
      </p>
      <div style="margin-bottom:12px;">
        <label style="display:block; font-size:12px; margin-bottom:4px; color:var(--text);">Master Key
          (å¿…å¡«)</label>
        <input type="password" id="cloudApiKey"
          style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--bg); color:var(--text); box-sizing:border-box;"
          placeholder="$2b$10$...">
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:12px; margin-bottom:4px; color:var(--text);">Bin ID
          (é€‰å¡«)</label>
        <input type="text" id="cloudBinId"
          style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--bg); color:var(--text); box-sizing:border-box;"
          placeholder="60d5f...">
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="cloudSettingsCancelBtn"
          style="padding:8px 16px; border:1px solid var(--border); background:transparent; border-radius:4px; cursor:pointer; color:var(--text);">å–æ¶ˆ</button>
        <button id="cloudSettingsSaveBtn"
          style="padding:8px 16px; border:none; background:var(--accent); color:#fff; border-radius:4px; cursor:pointer;">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- AI Configuration Modal -->
  <div id="aiConfigModalOverlay"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div
      style="background:var(--panel); width:90%; max-width:480px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.25); border:1px solid var(--border); display:flex; flex-direction:column;">
      <div
        style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--text); font-size:16px;">âš™ï¸ AI é…ç½®</h3>
        <button id="aiConfigCloseBtn"
          style="background:none; border:none; font-size:20px; cursor:pointer; color:var(--text);">&times;</button>
      </div>
      <div style="padding:20px; color:var(--text);">
        <!-- Provider Selection -->
        <div style="margin-bottom:15px;">
          <label style="display:block; font-size:12px; margin-bottom:6px; font-weight:600;">é€‰æ‹© AI æä¾›å•†</label>
          <div style="display:flex; gap:12px;">
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:13px;">
              <input type="radio" name="aiProvider" value="custom" checked> ç¬¬ä¸‰æ–¹ AI (OpenAI å…¼å®¹)
            </label>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:13px;">
              <input type="radio" name="aiProvider" value="gemini"> Gemini å®˜æ–¹
            </label>
          </div>
        </div>

        <!-- Dynamic Fields -->
        <div id="aiConfigFields">
          <!-- Populated by JS -->
        </div>

      </div>
      <div
        style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--bg);">
        <button id="aiConfigCancelBtn"
          style="padding:8px 16px; background:transparent; border:1px solid var(--border); color:var(--text); border-radius:4px; cursor:pointer;">å–æ¶ˆ</button>
        <button id="aiConfigSaveBtn"
          style="padding:8px 16px; background:var(--accent); color:#fff; border:none; border-radius:4px; cursor:pointer;">ä¿å­˜é…ç½®</button>
      </div>
    </div>
  </div>

  <!-- Gemini Q&A Modal -->
  <div id="geminiQAModalOverlay"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div
      style="background:var(--panel); width:90%; max-width:600px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:80vh;">
      <div
        style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--text);">âœ¨ è¯¢é—® AI</h3>
        <button id="geminiQACloseBtn"
          style="background:none; border:none; font-size:20px; cursor:pointer; color:var(--text);">&times;</button>
      </div>
      <div style="padding:15px; flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
        <div id="geminiQAChatHistory"
          style="flex:1; min-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:4px; padding:10px; background:var(--bg); margin-bottom:10px;">
          <div style="color:var(--text); opacity:0.7; text-align:center; margin-top:20px;">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒAI
            å°†æ ¹æ®æ‰€æœ‰è¡Œç¨‹æ•°æ®ï¼ˆç«è½¦+é£æœºï¼‰è¿›è¡Œå›ç­”ã€‚</div>
        </div>
        <div style="display:flex; gap:10px;">
          <input type="text" id="geminiQAInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ€»å…±å»äº†å¤šå°‘ä¸ªå›½å®¶ï¼Ÿå“ªä¸€å¹´å‡ºè¡Œæœ€é¢‘ç¹ï¼Ÿ"
            style="flex:1; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--bg); color:var(--text); user-select:text; -webkit-user-select:text; pointer-events:auto;"
            onkeydown="event.stopPropagation()" onkeypress="event.stopPropagation()"
            onmousedown="event.stopPropagation()" onclick="this.focus(); event.stopPropagation()">
          <button id="geminiQASendBtn"
            style="padding:8px 15px; background:var(--accent); color:#fff; border:none; border-radius:4px; cursor:pointer;">å‘é€</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/services/cloud_sync.js"></script>
  <script src="js/pages/index.js"></script>
  <!-- åŠŸèƒ½è¯´æ˜ Modal -->
  <div id="featuresHelpOverlay">
    <div id="featuresHelpModal">
      <button id="featuresHelpClose">&times;</button>
      <h3>åŠŸèƒ½æ€»è§ˆä¸ä½¿ç”¨è¯´æ˜</h3>
      <!-- å†…å®¹ç”± js/features_help.js åŠ¨æ€åŠ è½½ -->
    </div>
  </div>
  <script src="js/features_help.js"></script>
</body>

</html>